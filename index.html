<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KENYATAAN TUNTUTAN ELAUN PERJALANAN DALAM NEGERI WP1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Skema Warna Formal (Navy Blue/Grey) dan Kontras Tinggi */
        :root {
            --color-primary: #003366; /* Deep Navy Blue */
            --color-secondary: #f0f4f8; /* Light background grey/blue */
            --color-heading: #1e3a8a; /* Strong Blue for text */
            --color-accent: #b91c1c; /* Deep Red for action/important totals */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-secondary); 
            color: #1f2937; /* Darker text */
        }
        .form-container {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }
        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .section-title {
            /* Strong contrast title bar */
            background-color: var(--color-primary); 
            @apply text-lg font-extrabold text-white p-3 shadow-inner;
        }
        /* Style for sub-section headings, like "MAKLUMAT PEGAWAI" */
        .subsection-heading {
             background-color: #dbeafe; /* Lighter Blue background */
             color: #1e40af; /* Darker Blue text */
             @apply text-base font-bold p-2 border-b border-blue-300;
        }
        /* Highlight input yang dikira automatik */
        .auto-calculated {
            @apply bg-yellow-50 border-yellow-300 text-gray-800 font-semibold cursor-not-allowed;
        }
        /* Style for the editable header input */
        #claim_period {
            font-size: 0.875rem; 
            font-weight: 700; 
            padding: 0;
            height: auto;
            background-color: transparent;
            border: none;
            box-shadow: none;
            cursor: pointer;
            @apply text-center text-white hover:bg-blue-800 rounded px-1; 
        }
        /* Styling for the main header block */
        .main-header-block {
            background-color: var(--color-primary);
            color: white;
            @apply p-4 shadow-lg;
        }
        /* New structure for organizing form fields */
        .form-info-block {
             @apply p-3 rounded-lg mt-4 bg-gray-100 border border-gray-300;
        }


        /* PRINT STYLES */
        @media print {
            .no-print {
                display: none !important;
            }
            .form-input, textarea, select {
                border: none !important;
                background-color: transparent !important;
                box-shadow: none !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                padding: 0 !important;
            }
            .form-container {
                border: none;
                box-shadow: none;
            }
            .main-header-block {
                /* Ensure background color prints for header */
                background-color: var(--color-primary) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .section-title {
                background-color: #f1f5f9 !important; /* Lighter for paper */
                color: #1e3a8a !important; 
                border-bottom: 2px solid #1e3a8a;
                padding: 4px 0 !important;
                margin-top: 15px !important;
            }
            .subsection-heading {
                 background-color: #dbeafe !important;
                 color: #1e40af !important; 
                 border-bottom: 1px solid #93c5fd;
            }
            .page-break {
                page-break-after: always;
            }
            .toll-field-print {
                display: block !important;
                font-size: 10px;
                font-weight: 600;
                margin-top: 5px;
                padding-top: 5px;
                border-top: 1px dashed #ccc;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto bg-white form-container">
        <!-- Header FORMAL dengan Jata Pulau Pinang -->
        <header class="main-header-block grid grid-cols-12 items-center">
            <div class="col-span-2 sm:col-span-1">
                <!-- Logo Jata Pulau Pinang -->
                <img src="https://i.postimg.cc/HsVZqzF5/JATAPenang.png" onerror="this.onerror=null; this.src='https://placehold.co/64x64/003366/ffffff?text=JATA';" alt="Jata Pulau Pinang" class="h-16 w-auto object-contain">
            </div>
            <div class="col-span-10 sm:col-span-11 text-center pr-4">
                <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-white uppercase">KENYATAAN TUNTUTAN ELAUN PERJALANAN DALAM NEGERI WP1.4</h1>
                <!-- RUANGAN EDIBLE BARU -->
                <label for="claim_period" class="sr-only">Tempoh Tuntutan</label>
                <input type="text" id="claim_period" class="mt-1" value="BAGI BULAN NOVEMBER 2025" />
            </div>
        </header>

        <form id="claimForm" class="p-6 sm:p-8 space-y-8">
            
            <!-- MAKLUMAT PEGAWAI, KENDERAAN, ALAMAT -->
            <div class="space-y-4">
                <h3 class="subsection-heading">1. MAKLUMAT PEGAWAI</h3>
                
                <!-- MAKLUMAT PEGAWAI (GRID 2xN) -->
                <div class="form-info-block">
                    <p class="font-bold mb-3 text-blue-900">Butiran Peribadi & Jawatan</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                        <div class="col-span-1">
                            <label for="nama" class="form-label">Nama (Huruf Besar)</label>
                            <input type="text" id="nama" class="form-input" value="AHMAD HAFIZAN BIN ABD HALIM">
                        </div>
                        <div class="col-span-1">
                            <label for="ic_no" class="form-label">No. Kad Pengenalan</label>
                            <input type="text" id="ic_no" class="form-input" value="830316-07-5029">
                        </div>
                        <div class="col-span-1">
                            <label for="jawatan" class="form-label">Jawatan</label>
                            <input type="text" id="jawatan" class="form-input" value="PEMBANTU HAL EHWAL ISLAM">
                        </div>
                        <div class="col-span-1">
                            <label for="gred" class="form-label">Gred</label>
                            <input type="text" id="gred" class="form-input" value="S19">
                        </div>
                        <div class="col-span-1">
                            <label for="no_telefon" class="form-label">No. Telefon (Pejabat/Bimbit)</label>
                            <input type="text" id="no_telefon" class="form-input" value="010-4664237">
                        </div>
                    </div>
                </div>

                <!-- MAKLUMAT BANK -->
                <div class="form-info-block">
                     <p class="font-bold mb-3 text-blue-900">Butiran Akaun Bank</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
                         <div class="col-span-1">
                            <label for="no_akaun" class="form-label">No. Akaun Bank</label>
                            <input type="text" id="no_akaun" class="form-input" value="557344105638">
                        </div>
                        <div class="col-span-1">
                            <label for="nama_bank" class="form-label">Nama / Alamat Bank</label>
                            <input type="text" id="nama_bank" class="form-input" value="MAYBANK ISLAMIC CAWANGAN BAGAN BUTTERWORTH">
                        </div>
                    </div>
                </div>

                <!-- PENDAPATAN -->
                <div class="p-3 rounded-lg mt-4 bg-gray-100 border border-gray-300">
                    <p class="font-bold mb-2 text-blue-900">BUTIRAN PENDAPATAN (RM)</p>
                    <div class="grid grid-cols-3 gap-4">
                        <label for="gaji" class="form-label col-span-1">Gaji:</label>
                        <input type="number" step="0.01" class="form-input col-span-2" id="gaji" value="2737.03" oninput="calculateTotal()">
                        <label for="elaun_elaun" class="form-label col-span-1">Elaun-elaun:</label>
                        <input type="number" step="0.01" class="form-input col-span-2" id="elaun_elaun" value="765.00" oninput="calculateTotal()">
                        <label class="form-label col-span-1 font-bold text-red-700">Jumlah Pendapatan:</label>
                        <input type="number" step="0.01" class="form-input col-span-2 font-bold auto-calculated text-red-700" id="jumlah_pendapatan" readonly value="3502.03">
                    </div>
                </div>

                <!-- KENDERAAN -->
                <div class="form-info-block">
                    <p class="font-bold mb-2 text-blue-900">BUTIRAN KENDERAAN</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                        <!-- Kereta -->
                        <div class="p-3 border rounded-lg bg-white shadow-sm">
                            <p class="font-semibold text-gray-800 mb-2">Kereta</p>
                            <label for="kereta_model" class="form-label">Jenis / Model</label>
                            <input type="text" id="kereta_model" class="form-input mb-2" value="PRODUA/AXIA">
                            <label for="kereta_no" class="form-label">No. Pendaftaran</label>
                            <input type="text" id="kereta_no" class="form-input" value="PNP4264">
                        </div>
                        <!-- Motosikal (Left blank as per PDF data) -->
                        <div class="p-3 border rounded-lg bg-white shadow-sm">
                            <p class="font-semibold text-gray-800 mb-2">Motosikal</p>
                            <label for="motosikal_model" class="form-label">Jenis / Model</label>
                            <input type="text" id="motosikal_model" class="form-input mb-2">
                            <label for="motosikal_no" class="form-label">No. Pendaftaran</label>
                            <input type="text" id="motosikal_no" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- ALAMAT PEJABAT & RUMAH -->
                <div class="form-info-block">
                    <p class="font-bold mb-3 text-blue-900">BUTIRAN ALAMAT</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="alamat_pejabat" class="form-label">Alamat Pejabat</label>
                            <textarea id="alamat_pejabat" class="form-input h-24 text-sm">PEJABAT AGAMA DAERAH SEBERANG PERAI TENGAH 14000 BUKIT MERTAJAM PULAU PINANG</textarea>
                        </div>
                        <div>
                            <label for="alamat_rumah" class="form-label">Alamat Rumah Pegawai</label>
                            <textarea id="alamat_rumah" class="form-input h-24 text-sm">NO 35 PERSIARAN SEKSYEN 5/11 BANDAR PUTRA BERTAM 13200 KEPALA BATAS SEBERANG PERAI UTARA</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-break"></div>

            <!-- 2. BUTIRAN PERJALANAN (LAMPIRAN C) -->
            <div>
                <h3 class="subsection-heading">2. BUTIRAN PERJALANAN (LAMPIRAN C)</h3>
                <div class="overflow-x-auto rounded-b-lg shadow-md border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200" id="travel-table">
                        <thead class="bg-blue-100">
                            <tr>
                                <th class="p-3 text-xs font-bold text-left text-blue-800 uppercase w-24">Tarikh</th>
                                <th class="p-3 text-xs font-bold text-left text-blue-800 uppercase w-20">Masa</th>
                                <th class="p-3 text-xs font-bold text-left text-blue-800 uppercase">Tujuan/Tempat</th>
                                <th class="p-3 text-xs font-bold text-left text-blue-800 uppercase w-24">Jarak (km)</th>
                                <th class="p-3 text-xs font-bold text-center text-blue-800 uppercase w-16 no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="travel-rows">
                            <!-- Data inserted via JS -->
                        </tbody>
                        <tfoot>
                            <tr class="bg-blue-50 border-t-2 border-blue-200">
                                <td colspan="3" class="p-3 text-right font-extrabold text-blue-900">JUMLAH JARAK TUNTUTAN ELAUN KENDERAAN:</td>
                                <!-- Total Jarak Display -->
                                <td class="p-3 font-extrabold bg-blue-100">
                                    <input type="number" step="0.1" id="total-distance-input" class="w-full bg-transparent border-0 font-extrabold text-right auto-calculated text-blue-900" readonly>
                                </td>
                                <td class="p-3 no-print"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <button type="button" onclick="addTravelRow()" class="mt-4 w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out font-semibold flex items-center justify-center gap-2 no-print shadow-md">
                    <span class="text-xl font-bold">+</span> Tambah Butiran Perjalanan
                </button>
            </div>

            <!-- 3. RINGKASAN TUNTUTAN -->
            <div class="space-y-4">
                <h3 class="subsection-heading">3. RINGKASAN TUNTUTAN</h3>
                
                <!-- BAHAGIAN A: ELAUN PERJALANAN KENDERAAN -->
                <h4 class="text-base font-semibold text-blue-800 border-b pb-1 mb-2">BAHAGIAN A: ELAUN PERJALANAN KENDERAAN</h4>
                <div class="p-4 border rounded-lg bg-white shadow-sm">
                    <div class="grid grid-cols-4 gap-4 items-center mb-2 text-sm font-semibold text-gray-600 border-b pb-2">
                        <span class="col-span-1">Kategori Jarak</span>
                        <span class="col-span-1 text-center">Jarak (km)</span>
                        <span class="col-span-1 text-center">Kadar</span>
                        <span class="col-span-1 text-right">Jumlah (RM)</span>
                    </div>
                    <!-- 500 km pertama -->
                    <div class="grid grid-cols-4 gap-4 items-center py-2">
                        <label class="form-label text-xs sm:text-sm">500 km pertama</label>
                        <input type="number" step="0.1" class="form-input text-center text-sm auto-calculated" id="km_first" readonly>
                        <span class="text-center text-sm text-gray-500">0.85 sen/km</span>
                        <input type="number" step="0.01" class="form-input text-right bg-blue-50 font-semibold auto-calculated" id="total_first" readonly>
                    </div>
                    <!-- 501 km dan seterusnya -->
                    <div class="grid grid-cols-4 gap-4 items-center py-2">
                        <label class="form-label text-xs sm:text-sm">501 km dan seterusnya</label>
                        <input type="number" step="0.1" class="form-input text-center text-sm auto-calculated" id="km_second" readonly>
                        <span class="text-center text-sm text-gray-500">0.75 sen/km</span>
                        <input type="number" step="0.01" class="form-input text-right bg-blue-50 font-semibold auto-calculated" id="total_second" readonly>
                    </div>
                    <!-- Jumlah Elaun Kenderaan -->
                    <div class="text-right mt-4 pt-3 border-t">
                        <div class="flex justify-end items-center gap-4">
                            <label class="font-bold text-md text-gray-700">Jumlah Bahagian A (Kenderaan):</label>
                            <input type="number" step="0.01" class="w-32 p-2 border rounded bg-green-100 font-bold text-right auto-calculated" id="jumlah_bahagian_a" readonly>
                            <input type="hidden" id="jumlah_kenderaan_a" value="336.43"> <!-- Hidden ref -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- BAHAGIAN C: BELANJA PELBAGAI -->
            <div class="space-y-4">
                <h4 class="text-base font-semibold text-blue-800 border-b pb-1 mb-2">BAHAGIAN C: BELANJA PELBAGAI</h4>
                <div class="p-4 border rounded-lg bg-white shadow-sm">
                    <div class="grid grid-cols-12 gap-4 mb-2 font-bold text-sm text-gray-700 border-b pb-2">
                        <span class="col-span-6">Perkara</span>
                        <span class="col-span-3 text-center">Bil. Resit</span>
                        <span class="col-span-3 text-right">Amaun (RM)</span>
                    </div>

                    <!-- Tol (Auto-calculated) -->
                    <div class="grid grid-cols-12 gap-4 items-center py-2 bg-blue-50 rounded px-2">
                        <div class="col-span-6">
                            <label class="form-label font-semibold text-blue-900">Tol [Resit/TnG/RFID/Lain-lain]</label>
                            <span class="text-xs text-blue-600 no-print">*Dikira automatik dari Butiran Perjalanan</span>
                        </div>
                        <div class="col-span-3">
                            <!-- AUTOMATICALLY CALCULATED RESIT COUNT -->
                            <input type="number" class="form-input text-center bg-white auto-calculated" id="tol_resit" readonly> 
                        </div>
                        <div class="col-span-3">
                            <!-- READONLY: Dikira dari jadual -->
                            <input type="number" step="0.01" class="form-input text-right font-bold text-blue-700 auto-calculated" id="tol_amaun" readonly>
                        </div>
                    </div>

                    <!-- Tempat Letak Kereta -->
                    <div class="grid grid-cols-12 gap-4 items-center py-2 px-2">
                        <label class="col-span-6 form-label">Tempat Letak Kereta</label>
                        <div class="col-span-3">
                            <input type="number" class="form-input text-center" value="0" id="parking_resit" oninput="calculateTotalC()">
                        </div>
                        <div class="col-span-3">
                            <input type="number" step="0.01" class="form-input text-right" value="0.00" id="parking_amaun" oninput="calculateTotalC()">
                        </div>
                    </div>

                    <!-- Jumlah Bahagian C -->
                    <div class="text-right mt-4 pt-3 border-t">
                        <div class="flex justify-end items-center gap-4">
                            <label class="font-bold text-md text-gray-700">Jumlah Bahagian C:</label>
                            <input type="number" step="0.01" class="w-32 p-2 border rounded bg-blue-100 font-bold text-right auto-calculated" id="jumlah_bahagian_c" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JUMLAH KESELURUHAN -->
            <div class="p-6 bg-red-100 border-2 border-red-300 rounded-lg shadow-inner">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <label class="font-bold text-lg sm:text-xl text-red-900 mb-2 sm:mb-0">JUMLAH KESELURUHAN TUNTUTAN (A+B+C)</label>
                    <div class="flex items-center">
                        <span class="text-2xl font-bold text-red-800 mr-2">RM</span>
                        <input type="number" step="0.01" class="w-40 bg-white border-2 border-red-300 rounded p-2 text-2xl font-extrabold text-right text-red-800 auto-calculated" id="jumlah_keseluruhan" readonly>
                    </div>
                </div>
            </div>

            <!-- 4. PENGAKUAN & PENGESAHAN -->
            <div class="space-y-6 pt-6">
                <h3 class="subsection-heading">4. PENGAKUAN & PENGESAHAN</h3>
                
                <div class="flex justify-end space-x-2 no-print">
                    <button type="button" onclick="setTodayDate()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300 shadow-sm text-sm border">
                        Tetapkan Tarikh Hari Ini
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded bg-gray-50 shadow-sm">
                    <div>
                        <label class="form-label text-xs">Pendahuluan Diri diberi (RM)</label>
                        <input type="number" step="0.01" class="form-input bg-white" id="pd_diberi" value="0.00" oninput="calculateBalance()">
                    </div>
                    <div>
                        <label class="form-label text-xs">Tolak: Tuntutan sekarang (RM)</label>
                        <input type="number" step="0.01" class="form-input bg-gray-100 auto-calculated" id="pd_tuntutan_sekarang" readonly>
                    </div>
                    <div>
                        <label class="form-label text-xs font-bold text-blue-900">Baki dituntut/Baki dibayar balik (RM)</label>
                        <input type="number" step="0.01" class="form-input font-bold bg-yellow-100 auto-calculated text-blue-900" id="pd_baki" readonly>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                    <div class="p-3 border rounded-lg bg-white shadow-sm">
                        <label for="tarikh_pengakuan" class="form-label font-bold text-blue-900">Tarikh Pengakuan</label>
                        <input type="date" id="tarikh_pengakuan" class="form-input" value="2025-12-04">
                        <p class="font-bold mt-3 text-gray-800">Tandatangan Pemohon: (Tandatangan)</p>
                        <p>Nama: AHMAD HAFIZAN BIN HAJI ABD HALIM</p>
                        <p>Jawatan: Penyelia Kariah</p>
                    </div>
                    <div class="p-3 border rounded-lg bg-white shadow-sm">
                        <label for="tarikh_pengesahan" class="form-label font-bold text-blue-900">Tarikh Pengesahan</label>
                        <input type="date" id="tarikh_pengesahan" class="form-input" value="2025-12-04">
                        <p class="font-bold mt-3 text-gray-800">Tandatangan Pengesah: (Tandatangan)</p>
                        <p>Nama: HAMIZAH BINTI ISMAIL</p>
                        <p>Jawatan: Penolong Pegawai Hal Ehwal Islam, b.p. Ketua Setiausaha/ Pegawai Pengawal</p>
                    </div>
                </div>
                
                
                <div class="flex justify-between items-center space-x-4 no-print mt-8 pt-4 border-t-2">
                    <button type="submit" class="bg-blue-900 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 transition duration-300 shadow-md flex items-center border border-blue-900">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Simpan Borang Tuntutan
                    </button>
                    <!-- BUTANG JANA PDF/SLIP -->
                    <button type="button" onclick="window.print()" class="bg-red-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-800 transition duration-300 shadow-md flex items-center border border-red-700">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v3"></path></svg>
                        Jana Slip Tuntutan (PDF)
                    </button>
                </div>
            </div>


            <div id="message-box" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 z-50"></div>

        </form>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === RUANGAN KONFIGURASI PENGGUNA ===
        // GANTIKAN DENGAN KONFIGURASI FIREBASE ANDA
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA46atgGMUjain2N-IPSi5a2eqVRBNU_gg",
            authDomain: "tuntutan-perjalanan.firebaseapp.com",
            projectId: "tuntutan-perjalanan",
            storageBucket: "tuntutan-perjalanan.firebasestorage.app",
            messagingSenderId: "323029882074",
            appId: "1:323029882074:web:6d71babaf1e6102f0801e3"
        };
        // -------------------------------------


        // Tentukan Konfigurasi yang Digunakan
        // Jika MY_FIREBASE_CONFIG memiliki API Key yang sah, gunakan itu. Jika tidak, gunakan konfigurasi runtime (jika ada).
        const isUserConfigValid = MY_FIREBASE_CONFIG.apiKey && MY_FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY";
        
        const firebaseConfig = isUserConfigValid
            ? MY_FIREBASE_CONFIG
            : JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            
        // Gunakan Project ID dari konfigurasi jika tersedia, jika tidak, gunakan APP_ID runtime atau fallback default.
        const appId = firebaseConfig.projectId || (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
        
        let app, db, auth, userId = null, isAuthReady = false;

        // DATA AWAL. Menggunakan data dari PDF asal
        const TRAVEL_DATA = [
            { date: '04/11/2025', from: '14:00', to: '14:15', purpose: 'MESYUARAT PENYELARASAN SOLAT JUMAAT. Dari Pejabat Ke Masjid Pekan Permatang Pauh.', toll: 0.00, toll_plaza: '', km: 10.1 },
            { date: '04/11/2025', from: '16:30', to: '16:45', purpose: 'Dari Masjid Pekan Permatang Pauh ke Pejabat.', toll: 0.00, toll_plaza: '', km: 10.1 },
            { date: '06/11/2025', from: '07:00', to: '08:12', purpose: 'PELANTIKAN URUS SETIA BENGKEL... Dari Pejabat ke Hotel Bahang Bay, Pulau Pinang.', toll: 5.74, toll_plaza: 'Jambatan Pulau Pinang', km: 45.2 },
            { date: '07/11/2025', from: '11:30', to: '12:42', purpose: 'Dari Hotel Bahang Bay, Pulau Pinang ke Pejabat.', toll: 0.00, toll_plaza: '', km: 45.2 },
            { date: '07/11/2025', from: '17:00', to: '17:25', purpose: 'JEMPUTAN RAPTAI... Dari Rumah ke Tapak Masjid Madani.', toll: 1.31, toll_plaza: 'Tol Sungai Dua', km: 20.3 },
            { date: '07/11/2025', from: '20:00', to: '20:25', purpose: 'Dari Tapak Masjid Madani ke Rumah.', toll: 1.31, toll_plaza: 'Tol Bertam', km: 20.3 },
            { date: '08/11/2025', from: '07:30', to: '07:54', purpose: 'PELANTIKAN URUS SETIA... Dari Rumah ke Tapak Masjid Madani.', toll: 1.31, toll_plaza: 'Tol Sungai Dua', km: 20.3 },
            { date: '08/11/2025', from: '15:00', to: '15:24', purpose: 'Dari Tapak Masjid Madani ke Rumah.', toll: 1.31, toll_plaza: 'Tol Bertam', km: 20.3 },
            { date: '11/11/2025', from: '09:30', to: '09:57', purpose: 'PERSIAPAN TEKNIKAL... Dari Pejabat ke Pusat Konvensyen PERDA, Kubang Menerong.', toll: 0.00, toll_plaza: '', km: 17.8 },
            { date: '11/11/2025', from: '16:00', to: '16:27', purpose: 'Dari Pusat Konvensyen PERDA ke Pejabat.', toll: 0.00, toll_plaza: '', km: 17.8 },
            { date: '12/11/2025', from: '08:00', to: '08:27', purpose: 'LANTIKAN URUS SETIA TEKNIKAL... Dari Pejabat ke Pusat Konvensyen PERDA.', toll: 0.00, toll_plaza: '', km: 17.8 },
            { date: '12/11/2025', from: '11:00', to: '11:10', purpose: 'Dari Pusat Konvensyen PERDA ke Rumah.', toll: 0.00, toll_plaza: '', km: 5.5 },
            { date: '13/11/2025', from: '08:00', to: '08:27', purpose: 'Dari Pejabat ke Pusat Konvensyen PERDA.', toll: 0.00, toll_plaza: '', km: 17.8 },
            { date: '13/11/2025', from: '11:00', to: '11:10', purpose: 'Dari Pusat Konvensyen PERDA ke Rumah.', toll: 0.00, toll_plaza: '', km: 5.5 },
            { date: '20/11/2025', from: '14:15', to: '14:30', purpose: 'PROGRAM SOLAT JUMAAT... Dari Pejabat ke Masjid Pekan Permatang Pauh.', toll: 0.00, toll_plaza: '', km: 10.1 },
            { date: '20/11/2025', from: '16:30', to: '16:45', purpose: 'Dari Masjid Pekan Permatang Pauh ke Pejabat.', toll: 0.00, toll_plaza: '', km: 10.1 },
            { date: '21/11/2025', from: '10:00', to: '10:15', purpose: 'Dari Pejabat ke Masjid Pekan Permatang Pauh.', toll: 0.00, toll_plaza: '', km: 10.1 },
            { date: '21/11/2025', from: '15:00', to: '15:15', purpose: 'Dari Masjid Pekan Permatang Pauh ke Pejabat.', toll: 0.00, toll_plaza: '', km: 10.1 },
            { date: '29/11/2025', from: '08:00', to: '08:24', purpose: 'URUSETIA JAMUAN MAKAN... Dari Rumah ke Masjid Mengkuang Titi.', toll: 0.00, toll_plaza: '', km: 17.8 },
            { date: '29/11/2025', from: '17:00', to: '17:24', purpose: 'Dari Masjid Mengkuang Titi ke Rumah.', toll: 0.00, toll_plaza: '', km: 17.8 },
            { date: '30/11/2025', from: '07:15', to: '07:47', purpose: 'URUS SETIA SIMPOSIUM KEKELUARGAAN ISLAM (Dari Rumah ke Dewan Seminar The Light Hotel).', toll: 1.31, toll_plaza: 'Tol Sungai Dua', km: 22.9 },
            { date: '30/11/2025', from: '11:45', to: '12:17', purpose: 'Dari Dewan Seminar The Light Hotel ke Rumah.', toll: 1.31, toll_plaza: 'Tol Bertam', km: 22.9 },
        ];
        
        // FUNGSI UTAMA
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 3000);
        }

        async function initializeFirebase() {
            // Check if user provided their config OR if runtime config is available
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase configuration is missing.");
                 showMessage("Error: Konfigurasi Firebase tidak lengkap.", true);
                 return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use signInAnonymously since custom token is not provided by the user
                await signInAnonymously(auth);
                
                auth.onAuthStateChanged(user => {
                    if (user) { 
                        userId = user.uid; 
                        isAuthReady = true; 
                        // Set the correct Firestore path for private data
                        const storagePath = `artifacts/${appId}/users/${userId}/claims/november_2025_v2`;
                        console.log(`Firebase ready. Storing data at: ${storagePath}.`);
                        loadClaimData(storagePath);
                    } else { 
                        // Fallback for unauthenticated or anonymous user
                        userId = crypto.randomUUID(); 
                        isAuthReady = true; 
                        const storagePath = `artifacts/${appId}/users/${userId}/claims/november_2025_v2`;
                        console.log(`Signed in anonymously. Storing data at: ${storagePath}.`);
                        loadClaimData(storagePath);
                    }
                });
            } catch (error) { 
                console.error("Error initializing Firebase or signing in:", error); 
                showMessage(`Error Firebase: ${error.message}`, true);
            }
        }

        window.calculateTotal = function() {
            const gaji = document.getElementById('gaji') ? (parseFloat(document.getElementById('gaji').value) || 0) : 0;
            const elaun = document.getElementById('elaun_elaun') ? (parseFloat(document.getElementById('elaun_elaun').value) || 0) : 0;
            const jumlahPendapatanEl = document.getElementById('jumlah_pendapatan');
            if(jumlahPendapatanEl) jumlahPendapatanEl.value = (gaji + elaun).toFixed(2);
        }

        window.updateCalculations = function() {
            // SECURITY CHECK: Ensure rows element exists before accessing its children
            const travelRowsContainer = document.getElementById('travel-rows');
            if (!travelRowsContainer) {
                 // console.error("Travel rows container not found."); // Should not happen after DOM loads
                 return;
            }
            
            let totalKm = 0;
            let totalToll = 0;
            let totalTollCount = 0; // New counter for receipts
            
            const rows = travelRowsContainer.children;
            const travel_details = [];

            // 1. Kumpul data dan kira jumlah
            for(let row of rows) {
                // Ensure inputs exist within the row before accessing them
                const dateInput = row.querySelector('input[type="date"]');
                const fromInput = row.querySelectorAll('input[type="time"]')[0];
                const toInput = row.querySelectorAll('input[type="time"]')[1];
                const purposeArea = row.querySelector('textarea');
                const kmInput = row.querySelector('.km-input');
                const tollInput = row.querySelector('.toll-input');
                const tollPlazaInput = row.querySelector('.toll-plaza-input');

                if (!dateInput || !fromInput || !toInput || !purposeArea || !kmInput || !tollInput || !tollPlazaInput) {
                    console.warn("Skipping incomplete row:", row);
                    continue; // Skip the row if any critical input is missing
                }

                const date = dateInput.value;
                const from = fromInput.value;
                const to = toInput.value;
                const purpose = purposeArea.value;
                const km = parseFloat(kmInput.value) || 0;
                const toll = parseFloat(tollInput.value) || 0;
                const toll_plaza = tollPlazaInput.value;
                
                totalToll += toll;
                totalKm += km;
                
                if (toll > 0) {
                    totalTollCount++;
                }

                 travel_details.push({ date, from, to, purpose, km, toll, toll_plaza });
            }

            // Kemas kini paparan di kaki jadual
            const totalDistanceEl = document.getElementById('total-distance-input');
            if (totalDistanceEl) totalDistanceEl.value = totalKm.toFixed(1);

            // 2. Kemas kini Bahagian A (Kenderaan)
            let kmFirst = totalKm > 500 ? 500 : totalKm;
            let kmSecond = totalKm > 500 ? totalKm - 500 : 0;
            
            let amountFirst = kmFirst * 0.85;
            let amountSecond = kmSecond * 0.75;
            let totalVehicle = amountFirst + amountSecond;

            const kmFirstEl = document.getElementById('km_first');
            if (kmFirstEl) kmFirstEl.value = kmFirst.toFixed(1);
            
            const kmSecondEl = document.getElementById('km_second');
            if (kmSecondEl) kmSecondEl.value = kmSecond.toFixed(1);

            const totalFirstEl = document.getElementById('total_first');
            if (totalFirstEl) totalFirstEl.value = amountFirst.toFixed(2);
            
            const totalSecondEl = document.getElementById('total_second');
            if (totalSecondEl) totalSecondEl.value = amountSecond.toFixed(2);
            
            const jumlahBahagianAEl = document.getElementById('jumlah_bahagian_a');
            if (jumlahBahagianAEl) jumlahBahagianAEl.value = totalVehicle.toFixed(2);
            
            const jumlahKenderaanAEl = document.getElementById('jumlah_kenderaan_a');
            if (jumlahKenderaanAEl) jumlahKenderaanAEl.value = totalVehicle.toFixed(2);


            // 3. Kemas kini Bahagian C (Tol automatik)
            const tolAmaunEl = document.getElementById('tol_amaun');
            if (tolAmaunEl) tolAmaunEl.value = totalToll.toFixed(2);
            
            // KEMASKINI BILANGAN RESIT TOL
            const tolResitEl = document.getElementById('tol_resit');
            if (tolResitEl) tolResitEl.value = totalTollCount;
            
            // SECURITY CHECK for parking_amaun before accessing value
            const parkingAmaunInput = document.getElementById('parking_amaun');
            const parking = parkingAmaunInput ? (parseFloat(parkingAmaunInput.value) || 0) : 0;
            
            const totalC = totalToll + parking; // Tol + Parking + lain-lain
            const jumlahBahagianCEl = document.getElementById('jumlah_bahagian_c');
            if (jumlahBahagianCEl) jumlahBahagianCEl.value = totalC.toFixed(2);

            // 4. Kemas kini Jumlah Keseluruhan
            const totalBEl = document.getElementById('jumlah_bahagian_b');
            const totalB = totalBEl ? (parseFloat(totalBEl.value) || 0) : 0;

            const overallTotal = parseFloat(totalVehicle) + parseFloat(totalB) + parseFloat(totalC);
            
            const jumlahKeseluruhanEl = document.getElementById('jumlah_keseluruhan');
            if (jumlahKeseluruhanEl) jumlahKeseluruhanEl.value = overallTotal.toFixed(2);
            
            const pdTuntutanSekarangEl = document.getElementById('pd_tuntutan_sekarang');
            if (pdTuntutanSekarangEl) pdTuntutanSekarangEl.value = overallTotal.toFixed(2);


            // 5. Kira Baki
            window.calculateBalance();

            return travel_details; // Return updated travel details for saving
        }

        window.calculateBalance = function() {
            const pdDiberiEl = document.getElementById('pd_diberi');
            const pdDiberi = pdDiberiEl ? (parseFloat(pdDiberiEl.value) || 0) : 0;

            const tuntutanEl = document.getElementById('jumlah_keseluruhan');
            const tuntutan = tuntutanEl ? (parseFloat(tuntutanEl.value) || 0) : 0;

            const bakiEl = document.getElementById('pd_baki');
            if (bakiEl) bakiEl.value = (pdDiberi - tuntutan).toFixed(2);
        }
        
        window.calculateTotalC = function() {
            window.updateCalculations();
        }

        // FUNGSI BARU: TETAPKAN TARIKH HARI INI
        window.setTodayDate = function() {
            const tarikhPengakuanEl = document.getElementById('tarikh_pengakuan');
            const tarikhPengesahanEl = document.getElementById('tarikh_pengesahan');
            const today = new Date().toISOString().split('T')[0];
            
            if (tarikhPengakuanEl) tarikhPengakuanEl.value = today;
            if (tarikhPengesahanEl) tarikhPengesahanEl.value = today;
            
            showMessage("Tarikh pengakuan & pengesahan telah dikemas kini.");
        }


        function createTravelRow(data, index) {
            const row = document.createElement('tr');
            row.id = `travel-row-${index}`;
            row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
            
            const currentTollPlaza = data.toll_plaza || '';
            const currentToll = parseFloat(data.toll || 0).toFixed(2);

            row.innerHTML = `
                <td class="p-2 align-top"><input type="date" value="${data.date.split('/').reverse().join('-')}" class="form-input text-xs" onchange="updateCalculations()"></td>
                <td class="p-2 align-top">
                    <input type="time" value="${data.from}" class="form-input text-xs mb-1" onchange="updateCalculations()">
                    <input type="time" value="${data.to}" class="form-input text-xs" onchange="updateCalculations()">
                </td>
                
                <!-- RUANG TUJUAN/TEMPAT DENGAN INPUT PLAZA TOL DAN AMAUN BERASINGAN -->
                <td class="p-2 align-top">
                    <textarea class="w-full text-xs border border-gray-300 rounded p-2 h-16 resize-none focus:ring-blue-500 focus:border-blue-500 mb-1" oninput="updateCalculations()">${data.purpose}</textarea>
                    
                    <div class="mt-1 pt-1 border-t border-dashed border-gray-300 space-y-1">
                        <!-- NEW PLAZA INPUT FIELD -->
                        <label class="block text-xs font-bold text-gray-700 no-print">Plaza Tol (Masuk/Keluar):</label>
                        <input type="text" value="${currentTollPlaza}" class="form-input text-xs toll-plaza-input border-gray-300" oninput="updateCalculations()" placeholder="Contoh: Tol Sungai Dua / Tol Bertam">

                        <!-- EXISTING TOLL AMOUNT INPUT FIELD -->
                        <label class="block text-xs font-bold text-blue-700 mt-2 mb-1 no-print">Tuntutan Tol (RM):</label>
                        <input type="number" step="0.01" value="${currentToll}" class="form-input text-xs text-right toll-input border-blue-300" oninput="updateCalculations()" placeholder="0.00">
                        
                        <!-- PRINT DISPLAY -->
                        <span class="toll-field-print text-gray-800 hidden">
                           Tol: ${currentTollPlaza} (RM ${currentToll})
                        </span>
                    </div>
                </td>
                
                <td class="p-2 align-top"><input type="number" step="0.1" value="${data.km}" class="form-input text-xs text-right km-input" oninput="updateCalculations()"></td>
                <td class="p-2 align-top text-center no-print">
                    <button type="button" onclick="removeTravelRow('${row.id}')" class="text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded border border-red-200 hover:bg-red-50">Hapus</button>
                </td>
            `;
            return row;
        }

        // FUNGSI UNTUK MENGEMASKINI PAPARAN TOL PADA MASA CETAK (Media Print CSS)
        function updatePrintTollDisplay() {
            const rows = document.getElementById('travel-rows').children;
            for(let row of rows) {
                const tollInput = row.querySelector('.toll-input');
                const tollPlazaInput = row.querySelector('.toll-plaza-input');
                const tollPrintSpan = row.querySelector('.toll-field-print');
                
                if (tollInput && tollPrintSpan && tollPlazaInput) {
                    const tollAmount = parseFloat(tollInput.value) || 0;
                    const tollPlaza = tollPlazaInput.value.trim();
                    
                    let printText = '';
                    if (tollPlaza || tollAmount > 0) {
                        printText = `Tol: ${tollPlaza} (RM ${tollAmount.toFixed(2)})`;
                    }
                    
                    tollPrintSpan.textContent = printText;
                    
                    // Hide the interactive inputs and show the static display
                    if (tollAmount > 0 || tollPlaza) {
                         tollPrintSpan.classList.remove('hidden');
                    }
                    tollInput.classList.add('no-print');
                    tollPlazaInput.classList.add('no-print');
                }
            }
        }

        window.addTravelRow = function() {
            const tbody = document.getElementById('travel-rows');
            const newIndex = tbody.children.length + Date.now();
            const today = new Date().toISOString().split('T')[0];
            const emptyData = { date: today.split('-').reverse().join('/'), from: '08:00', to: '09:00', purpose: 'Tujuan perjalanan dan butiran laluan.', toll: 0.00, toll_plaza: '', km: 0.0 };
            tbody.appendChild(createTravelRow(emptyData, newIndex));
            updateCalculations();
        }

        window.removeTravelRow = function(rowId) {
            document.getElementById(rowId).remove();
            updateCalculations();
        }

        function populateTravelTable(data) {
            const tbody = document.getElementById('travel-rows');
            tbody.innerHTML = '';
            data.forEach((item, index) => tbody.appendChild(createTravelRow(item, index)));
        }

        async function saveClaimData() {
            if (!isAuthReady) { showMessage("Sila tunggu sehingga pengesahan dimuatkan.", true); return; }
            const claimDocRef = doc(db, `artifacts/${appId}/users/${userId}/claims`, 'november_2025_v2');
            
            // Get all data, including calculated travel details
            const travel_details = window.updateCalculations();

            const formData = {
                // Collect basic info
                nama: document.getElementById('nama').value,
                ic_no: document.getElementById('ic_no').value,
                jawatan: document.getElementById('jawatan').value,
                gred: document.getElementById('gred').value,
                no_akaun: document.getElementById('no_akaun').value,
                nama_bank: document.getElementById('nama_bank').value,
                no_telefon: document.getElementById('no_telefon').value,
                gaji: parseFloat(document.getElementById('gaji').value) || 0,
                elaun_elaun: parseFloat(document.getElementById('elaun_elaun').value) || 0,
                kereta_model: document.getElementById('kereta_model').value,
                kereta_no: document.getElementById('kereta_no').value,
                alamat_pejabat: document.getElementById('alamat_pejabat').value,
                alamat_rumah: document.getElementById('alamat_rumah').value,
                claim_period: document.getElementById('claim_period').value, // NEW FIELD
                
                travel_details: travel_details, // Updated travel details
                
                // Collect calculated values
                total_distance: parseFloat(document.getElementById('total-distance-input').value) || 0,
                jumlah_kenderaan_a: parseFloat(document.getElementById('jumlah_kenderaan_a').value) || 0,
                jumlah_bahagian_a: parseFloat(document.getElementById('jumlah_bahagian_a').value) || 0,
                jumlah_bahagian_b: parseFloat(document.getElementById('jumlah_bahagian_b').value) || 0,
                tol_amaun: parseFloat(document.getElementById('tol_amaun').value) || 0,
                parking_amaun: parseFloat(document.getElementById('parking_amaun').value) || 0,
                jumlah_bahagian_c: parseFloat(document.getElementById('jumlah_bahagian_c').value) || 0,
                jumlah_keseluruhan: parseFloat(document.getElementById('jumlah_keseluruhan').value) || 0,
                pd_diberi: parseFloat(document.getElementById('pd_diberi').value) || 0,
                pd_baki: parseFloat(document.getElementById('pd_baki').value) || 0,
                tarikh_pengakuan: document.getElementById('tarikh_pengakuan').value,
                tarikh_pengesahan: document.getElementById('tarikh_pengesahan').value,
                timestamp: serverTimestamp()
            };

            try {
                await setDoc(claimDocRef, formData, { merge: true });
                showMessage("Borang berjaya disimpan!");
            } catch (e) { showMessage("Ralat menyimpan.", true); }
        }

        async function loadClaimData(customPath) {
            if (!isAuthReady) return;
            // Use the path determined during initialization (either custom or default)
            const claimDocRef = doc(db, customPath);
            try {
                const docSnap = await getDoc(claimDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // Populate form fields
                    if (document.getElementById('nama')) document.getElementById('nama').value = data.nama || '';
                    if (document.getElementById('ic_no')) document.getElementById('ic_no').value = data.ic_no || '';
                    if (document.getElementById('jawatan')) document.getElementById('jawatan').value = data.jawatan || '';
                    if (document.getElementById('gred')) document.getElementById('gred').value = data.gred || '';
                    if (document.getElementById('no_akaun')) document.getElementById('no_akaun').value = data.no_akaun || '';
                    if (document.getElementById('nama_bank')) document.getElementById('nama_bank').value = data.nama_bank || '';
                    if (document.getElementById('no_telefon')) document.getElementById('no_telefon').value = data.no_telefon || '';
                    
                    if (document.getElementById('gaji')) document.getElementById('gaji').value = (data.gaji || 0).toFixed(2);
                    if (document.getElementById('elaun_elaun')) document.getElementById('elaun_elaun').value = (data.elaun_elaun || 0).toFixed(2);
                    
                    if (document.getElementById('kereta_model')) document.getElementById('kereta_model').value = data.kereta_model || '';
                    if (document.getElementById('kereta_no')) document.getElementById('kereta_no').value = data.kereta_no || '';
                    if (document.getElementById('alamat_pejabat')) document.getElementById('alamat_pejabat').value = data.alamat_pejabat || '';
                    if (document.getElementById('alamat_rumah')) document.getElementById('alamat_rumah').value = data.alamat_rumah || '';
                    
                    if (document.getElementById('pd_diberi')) document.getElementById('pd_diberi').value = (data.pd_diberi || 0).toFixed(2);
                    if (document.getElementById('parking_amaun')) document.getElementById('parking_amaun').value = (data.parking_amaun || 0).toFixed(2);
                    if (document.getElementById('tarikh_pengakuan')) document.getElementById('tarikh_pengakuan').value = data.tarikh_pengakuan || '';
                    if (document.getElementById('tarikh_pengesahan')) document.getElementById('tarikh_pengesahan').value = data.tarikh_pengesahan || '';
                    if (document.getElementById('claim_period')) document.getElementById('claim_period').value = data.claim_period || 'BAGI BULAN NOVEMBER 2025'; // NEW LOAD

                    // Populate travel details
                    if(data.travel_details && data.travel_details.length > 0) {
                        const formatted = data.travel_details.map(t => ({
                            ...t, 
                            km: parseFloat(t.km).toFixed(1), // Ensure km is formatted correctly
                            toll: parseFloat(t.toll || 0), // Ensure toll is read correctly
                            toll_plaza: t.toll_plaza || '', // Ensure plaza name is read correctly
                            date: t.date.includes('/') ? t.date : t.date.split('-').reverse().join('/')
                        }));
                        populateTravelTable(formatted);
                    } else {
                        populateTravelTable(TRAVEL_DATA);
                    }
                    showMessage("Data dimuatkan.");
                } else {
                    populateTravelTable(TRAVEL_DATA);
                    if (document.getElementById('claim_period')) document.getElementById('claim_period').value = 'BAGI BULAN NOVEMBER 2025'; // NEW FALLBACK
                }
                
                // Ensure calculations run after all data elements are present
                window.calculateTotal();
                window.updateCalculations();
                
            } catch (e) { 
                console.error("Load Error:", e);
                // Menunjukkan pesan yang lebih informatif karena kesalahan "offline"
                if (e.message && e.message.includes("offline")) {
                     showMessage("Gagal menyambung ke Firebase (Client is offline). Memuat data lalai.", true);
                } else {
                     showMessage("Gagal memuat data dari Firestore. Memuat data lalai.", true);
                }
                populateTravelTable(TRAVEL_DATA); 
                window.calculateTotal();
                window.updateCalculations();
            }
        }
        
        // Listener untuk update print display sebelum cetak
        window.addEventListener('beforeprint', updatePrintTollDisplay);
        window.addEventListener('afterprint', () => {
            // Restore visibility after printing if necessary
            const tollInputs = document.querySelectorAll('.toll-input');
            const tollPlazaInputs = document.querySelectorAll('.toll-plaza-input');
            const tollPrintSpans = document.querySelectorAll('.toll-field-print');
            
            tollInputs.forEach(input => input.classList.remove('no-print'));
            tollPlazaInputs.forEach(input => input.classList.remove('no-print'));
            tollPrintSpans.forEach(span => span.classList.add('hidden'));
        });


        document.getElementById('claimForm').addEventListener('submit', (e) => { e.preventDefault(); saveClaimData(); });
        window.onload = function() { initializeFirebase(); calculateTotal(); };
    </script>
</body>
</html>
